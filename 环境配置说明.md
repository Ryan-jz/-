# 环境配置说明

## 项目结构

```
项目根目录/
├── backend/              后端 Go 项目
├── frontend-admin/       后台管理系统（Vue3 + Element Plus）
├── frontend-web/         前台网站（Vue3 + UnoCSS）
├── 打包脚本.bat          一键打包脚本
└── 前端部署说明.md       部署文档
```

## 环境变量配置

### 后端 (backend)

配置文件：`backend/manifest/config/config.yaml`

```yaml
server:
  address: ":8000"
  url: "http://8.133.175.112:8000"  # ⚠️ 生产环境必须配置

database:
  default:
    link: "mysql:root:密码@tcp(127.0.0.1:3306)/bai_jin_yan"  # ⚠️ 必须配置
```

### 前台网站 (frontend-web)

**开发环境** `.env.local`
```env
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

**生产环境** `.env.production`
```env
VITE_API_BASE_URL=http://8.133.175.112:8000/api/v1
```

### 后台管理系统 (frontend-admin)

**开发环境** `.env`
```env
VITE_API_BASE_URL=http://localhost:8000
```

**生产环境** `.env.production`
```env
VITE_API_BASE_URL=http://8.133.175.112:8000
```

## 开发环境

### 前置要求

- Node.js 18+
- pnpm 8+
- Go 1.20.14
- MySQL 5.7+

### 启动开发环境

#### 1. 启动后端
```bash
cd backend
# 修改 manifest/config/config.yaml 配置数据库
go run main.go
```
访问：http://localhost:8000

#### 2. 启动前台网站
```bash
cd frontend-web
pnpm install
pnpm dev
```
访问：http://localhost:5174

#### 3. 启动后台管理系统
```bash
cd frontend-admin
pnpm install
pnpm dev
```
访问：http://localhost:5173

## 生产环境

### 服务器信息

- **公网 IP**: 8.133.175.112
- **操作系统**: Windows Server 2008 R2
- **后端端口**: 8000
- **前端端口**: 80 (Web), 8080 (Admin)

### 一键打包

运行根目录下的打包脚本：
```bash
打包脚本.bat
```

这会自动：
1. 打包后台管理系统 → `frontend-admin/dist`
2. 打包前台网站 → `frontend-web/dist`
3. 复制后端部署包 → `backend/dist`
4. 创建统一部署包 → `deploy/`

### 部署步骤

#### 1. 后端部署

将 `deploy/backend/` 目录上传到服务器：

```bash
# 1. 配置数据库连接
编辑 manifest/config/config.yaml

# 2. 导入数据库
按顺序导入 manifest/sql/ 下的 SQL 文件

# 3. 启动服务
双击 start.bat 或运行 bai-jin-yan-api.exe
```

#### 2. 前端部署

**方案 A: 使用 Nginx（推荐）**

```nginx
# 前台网站
server {
    listen 80;
    server_name 8.133.175.112;
    root /var/www/web;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# 后台管理
server {
    listen 8080;
    server_name 8.133.175.112;
    root /var/www/admin;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

**方案 B: 使用 IIS**

1. 创建两个网站
2. 分别指向 `deploy/web` 和 `deploy/admin`
3. 添加 URL Rewrite 规则支持前端路由

## API 地址配置

### 自动切换机制

项目已配置环境自动切换：

- **开发环境** (`pnpm dev`)：使用 `localhost:8000`
- **生产环境** (`pnpm build`)：使用 `8.133.175.112:8000`

### 手动修改

如果需要修改 API 地址：

1. **前台网站**：修改 `frontend-web/.env.production`
2. **后台管理**：修改 `frontend-admin/.env.production`
3. **后端配置**：修改 `backend/manifest/config/config.yaml` 中的 `server.url`

## 端口说明

| 服务 | 开发环境 | 生产环境 |
|------|---------|---------|
| 后端 API | 8000 | 8000 |
| 前台网站 | 5174 | 80 |
| 后台管理 | 5173 | 8080 |

## 跨域配置

### 开发环境

使用 Vite 代理（已配置）：

```js
// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
}
```

### 生产环境

后端已配置 CORS，允许跨域访问：

```go
// 允许的域名
AllowOrigin: "*"
```

## 文件上传配置

### 后端配置

上传文件保存在：`backend/public/uploads/`

- 图片：`public/uploads/images/`
- 视频：`public/uploads/videos/`

### 访问路径

上传后返回完整 URL：
```
http://8.133.175.112:8000/uploads/images/2025/12/28/xxx.jpg
```

⚠️ **重要**：必须在 `config.yaml` 中配置 `server.url`，否则返回的 URL 不正确！

## 数据库配置

### 开发环境
```yaml
database:
  default:
    link: "mysql:root:123456@tcp(127.0.0.1:3306)/bai_jin_yan"
```

### 生产环境
```yaml
database:
  default:
    link: "mysql:root:生产密码@tcp(127.0.0.1:3306)/bai_jin_yan"
```

### 初始化

按顺序导入 SQL 文件：
1. `init.sql` - 初始化
2. `sys_user.sql` - 用户表
3. `product.sql` - 产品表
4. `recipe.sql` - 食谱表
5. `banner.sql` - 轮播图表
6. `update_password.sql` - 更新密码

## 默认账号

- **用户名**: admin
- **密码**: admin

⚠️ 首次登录后请立即修改密码！

## 常见问题

### Q1: API 请求失败
检查：
1. 后端服务是否启动
2. 防火墙是否开放 8000 端口
3. `.env.production` 中的 API 地址是否正确

### Q2: 上传文件无法访问
检查：
1. `config.yaml` 中的 `server.url` 是否配置
2. `public/uploads` 目录是否有写入权限
3. 防火墙是否开放 8000 端口

### Q3: 页面刷新 404
需要配置服务器支持前端路由（History Mode）

### Q4: 跨域问题
1. 确认后端 CORS 配置正确
2. 或使用 Nginx 反向代理

## 监控和日志

### 后端日志
位置：`backend/temp/logs/`
按日期自动分割

### 前端日志
浏览器控制台查看

### 性能监控
可以使用：
- 后端：Prometheus + Grafana
- 前端：Sentry 或 Google Analytics

## 备份建议

定期备份：
1. 数据库（每天）
2. 上传文件（每周）
3. 配置文件（修改后）

## 安全建议

1. 修改默认密码
2. 配置 HTTPS
3. 限制 API 访问频率
4. 定期更新依赖
5. 配置防火墙规则

## 技术栈

### 后端
- Go 1.20.14
- GoFrame v2.6.4
- MySQL 5.7+

### 前端
- Vue 3
- Vite 5
- Element Plus (Admin)
- UnoCSS (Web)
- Axios

## 联系方式

如有问题，请查看：
- `前端部署说明.md`
- `backend/Windows_Server_2008_R2_部署说明.txt`
- `backend/编译成功-可以部署.txt`
