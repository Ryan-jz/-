# 前端项目部署说明

## 环境配置

项目已配置好开发环境和生产环境的自动切换。

### 后台管理系统 (frontend-admin)

**开发环境** (`.env`)
```
VITE_API_BASE_URL=http://localhost:8000
```

**生产环境** (`.env.production`)
```
VITE_API_BASE_URL=http://8.133.175.112:8000
```

### 前台网站 (frontend-web)

**开发环境** (`.env.local`)
```
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

**生产环境** (`.env.production`)
```
VITE_API_BASE_URL=http://8.133.175.112:8000/api/v1
```

## 开发环境运行

### 后台管理系统
```bash
cd frontend-admin
pnpm install
pnpm dev
```
访问：http://localhost:5173

### 前台网站
```bash
cd frontend-web
pnpm install
pnpm dev
```
访问：http://localhost:5174

## 生产环境打包

### 后台管理系统
```bash
cd frontend-admin
pnpm build
```
打包后的文件在 `frontend-admin/dist` 目录

### 前台网站
```bash
cd frontend-web
pnpm build
```
打包后的文件在 `frontend-web/dist` 目录

## 部署到服务器

### 方案 1：使用 Nginx 部署（推荐）

#### 1. 上传文件
将打包好的 `dist` 目录上传到服务器：
- 后台管理系统：`/var/www/admin`
- 前台网站：`/var/www/web`

#### 2. 配置 Nginx

创建配置文件 `/etc/nginx/sites-available/bai-jin-yan`：

```nginx
# 前台网站
server {
    listen 80;
    server_name 8.133.175.112;  # 或者你的域名
    
    root /var/www/web;
    index index.html;
    
    # 前端路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# 后台管理系统
server {
    listen 80;
    server_name admin.8.133.175.112;  # 或者你的管理后台域名
    
    root /var/www/admin;
    index index.html;
    
    # 前端路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# API 反向代理（可选，如果需要解决跨域问题）
server {
    listen 80;
    server_name api.8.133.175.112;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 3. 启用配置
```bash
sudo ln -s /etc/nginx/sites-available/bai-jin-yan /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 方案 2：直接使用 HTTP 服务器

#### 使用 serve (Node.js)
```bash
npm install -g serve

# 前台网站
cd frontend-web/dist
serve -s . -p 80

# 后台管理系统
cd frontend-admin/dist
serve -s . -p 8080
```

#### 使用 Python HTTP Server
```bash
# 前台网站
cd frontend-web/dist
python -m http.server 80

# 后台管理系统
cd frontend-admin/dist
python -m http.server 8080
```

### 方案 3：Windows Server 部署

#### 使用 IIS

1. 安装 IIS 和 URL Rewrite 模块
2. 创建网站，指向 `dist` 目录
3. 添加 `web.config` 文件支持前端路由：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="Handle History Mode and custom 404/500" stopProcessing="true">
          <match url="(.*)" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="/" />
        </rule>
      </rules>
    </rewrite>
    <staticContent>
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <mimeMap fileExtension=".woff" mimeType="application/font-woff" />
      <mimeMap fileExtension=".woff2" mimeType="application/font-woff2" />
    </staticContent>
  </system.webServer>
</configuration>
```

## 访问地址

部署完成后：

- **前台网站**：http://8.133.175.112
- **后台管理系统**：http://8.133.175.112:8080 或 http://admin.8.133.175.112
- **API 接口**：http://8.133.175.112:8000

## 注意事项

### 1. 跨域问题
如果遇到跨域问题，有两种解决方案：

**方案 A：后端配置 CORS**（已配置）
后端已经配置了 CORS，允许跨域访问。

**方案 B：使用 Nginx 反向代理**
通过 Nginx 代理 API 请求，避免跨域。

### 2. 防火墙配置
确保服务器防火墙开放以下端口：
- 80 (HTTP)
- 443 (HTTPS，如果使用)
- 8000 (后端 API)

```bash
# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload

# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8000/tcp
```

### 3. HTTPS 配置（推荐）
生产环境建议使用 HTTPS：

```bash
# 使用 Let's Encrypt 免费证书
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

### 4. 环境变量检查
打包前确认环境变量正确：
```bash
# 查看当前环境
echo $NODE_ENV

# 强制使用生产环境打包
NODE_ENV=production pnpm build
```

### 5. 构建优化
如果打包文件过大，可以优化：
- 启用 gzip 压缩
- 使用 CDN 加载第三方库
- 代码分割和懒加载

## 常见问题

### Q1: 页面刷新后 404
A: 需要配置服务器支持前端路由（History Mode），参考上面的 Nginx 或 IIS 配置。

### Q2: API 请求失败
A: 检查：
1. 后端服务是否启动
2. 防火墙是否开放 8000 端口
3. `.env.production` 中的 API 地址是否正确

### Q3: 静态资源加载失败
A: 检查 `vite.config.js` 中的 `base` 配置，确保路径正确。

### Q4: 打包后文件过大
A: 
1. 检查是否包含了 source map（生产环境应该关闭）
2. 使用 `pnpm build --report` 分析包大小
3. 考虑使用 CDN 加载大型库

## 自动化部署（可选）

可以使用 GitHub Actions 或其他 CI/CD 工具自动部署：

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build
        run: pnpm build
      
      - name: Deploy to server
        uses: easingthemes/ssh-deploy@v2
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: 8.133.175.112
          REMOTE_USER: root
          SOURCE: "dist/"
          TARGET: "/var/www/web/"
```

## 总结

1. 开发环境使用 `pnpm dev`，自动使用本地 API
2. 生产环境使用 `pnpm build`，自动使用生产服务器 API
3. 将 `dist` 目录部署到服务器
4. 配置 Nginx 或 IIS 支持前端路由
5. 确保防火墙开放必要端口
